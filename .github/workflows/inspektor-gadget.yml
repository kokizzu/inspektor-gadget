name: Compile Inspektor Gadget
on:
  push:

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      CONTAINER_REPO: ${{ secrets.CONTAINER_REPO }}
    steps:
    - name: Check repo is clean
      run: |
        # Prevent releases with -dirty suffix due to forgotten entries in
        # .gitignore.
        changes="$(git status --porcelain)"
        if [ -n "$changes" ] ; then
          echo "$changes"
          exit 1
        fi

    - name: Set up Go 1.16
      uses: actions/setup-go@v1
      with:
        go-version: 1.16
      id: go

    - name: Check out code
      uses: actions/checkout@v1

    - name: Cache external deps
      uses: actions/cache@v2
      with:
        # - Tests (tests.mk) need etcd, kube-apiserver, kubectl
        # - Generating code (crd.mk) needs controller-gen
        path: |
          bin/etcd
          bin/kube-apiserver
          bin/kubectl
          bin/controller-gen
        key: ${{ runner.os }}-${{ hashFiles('tests.mk', 'crd.mk', '.github/workflows/inspektor-gadget.yml') }}

    - name: Cache deb packages
      uses: actions/cache@v2
      id: cache-debs
      with:
          path: "~/cache-debs"
          key: cache-debs-libbpf-1:0.4.0-1ubuntu1-libseccomp-2.5.1-1ubuntu1~20.04.1

    - name: Install deb packages
      env:
        CACHE_HIT: ${{steps.cache-debs.outputs.cache-hit}}
        LIBBPF_VERSION: "1:0.4.0-1ubuntu1"
        LIBSECCOMP_VERSION: "2.5.1-1ubuntu1~20.04.1"
      run: |
          if [[ "$CACHE_HIT" == 'true' ]]; then
            sudo cp --verbose --force --recursive ~/cache-debs/* /
          else
            sudo apt install -y software-properties-common
            sudo add-apt-repository -y ppa:tuxinvader/kernel-build-tools
            sudo apt-get update
            sudo apt install -y libbpf-dev="$LIBBPF_VERSION" libseccomp-dev="$LIBSECCOMP_VERSION"
            mkdir -p ~/cache-debs
            sudo dpkg -L libbpf-dev libseccomp-dev | \
                while IFS= read -r f; do \
                    if test -f $f; then echo $f; fi; \
                done | xargs cp --parents --target-directory ~/cache-debs/
          fi

    - name: Cache Go modules
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Set IMAGE_TAG
      run: |
        TMP1=${GITHUB_REF#*/}
        TMP2=${TMP1#*/}
        IMAGE_TAG=${TMP2//\//-}
        if [ "$IMAGE_TAG" = "main" ]; then
            IMAGE_TAG="latest"
        fi
        echo IMAGE_TAG=$IMAGE_TAG >> $GITHUB_ENV

    - name: Check if generated files are updated
      run: |
        make manifests generate generate-documentation
        git diff --exit-code HEAD --

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-single-buildx-${{ hashFiles('gadget.Dockerfile') }}
        restore-keys: |
          ${{ runner.os }}-single-buildx

    - name: Login to Container Registry
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.CONTAINER_REGISTRY }}
        username: ${{ secrets.CONTAINER_REGISTRY_USERNAME }}
        password: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}

    - name: Build gadget container
      uses: docker/build-push-action@v2
      with:
        context: .
        file: gadget.Dockerfile
        # TODO: how to avoid pushing a container before running integration tests
        push: true
        tags: ${{ secrets.CONTAINER_REPO }}:${{ env.IMAGE_TAG }}
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new

      # Temp fix
      # https://github.com/docker/build-push-action/issues/252
      # https://github.com/moby/buildkit/issues/1896
    - name: Move Docker layers cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Build kubectl gadget plugin for all platforms
      run: |
        make -j$(nproc) kubectl-gadget-all

    - name: Build local-gadget for all platforms
      run: |
        make -j$(nproc) local-gadget-all

    - name: Basic unit tests
      run: |
        make test

    - name: Unit tests for the controller
      run: |
        make controller-tests

    - name: Unit tests for local-gadget (as root)
      run: |
        KERNEL=$(uname -r)
        ARCH=$(uname -m)
        if test -f /sys/kernel/btf/vmlinux; then
          echo "BTF is available at /sys/kernel/btf/vmlinux"
        else
          echo "BTF is not available: Trying BTFHub"
          source /etc/os-release
          URL="https://github.com/aquasecurity/btfhub/raw/main/archive/$ID/$VERSION_ID/$ARCH/$KERNEL.btf.tar.xz"
          echo "Trying to download vmlinux from $URL"

          if [[ $(wget -S --spider "$URL" 2>&1 | grep 'HTTP/1.1 200 OK') ]]; then
            wget -q -O /tmp/vmlinux.btf.tar.xz "$URL"
            tar -xvf /tmp/vmlinux.btf.tar.xz
            # Use objcopy to put the btf info in an ELF file as libbpf and cilium/ebpf
            # by default check if there is an ELF file with the .BTF section at
            # /boot/vmlinux-$KERNEL.
            sudo objcopy --input binary --output elf64-little --rename-section .data=.BTF *.btf /boot/vmlinux-$KERNEL
            rm *.btf
            echo "vmlinux downloaded at /boot/vmlinux-$KERNEL"
          else
            echo "vmlinux not found"
          fi
        fi

        make local-gadget-tests

    - name: Setup Minikube
      uses: manusa/actions-setup-minikube@v2.4.2
      with:
        minikube version: 'v1.9.2'
        kubernetes version: 'v1.18.2'
        github token: ${{ secrets.GITHUB_TOKEN }}

    - name: Integration tests
      run: |
        echo "Using IMAGE_TAG=$IMAGE_TAG"

        TESTS_DOCKER_ARGS="-e KUBECONFIG=/root/.kube/config -v /home/runner/.kube:/root/.kube -v /home/runner/work/_temp/.minikube:/home/runner/work/_temp/.minikube" \
            make -C integration build test

        sed -i "s/latest/$IMAGE_TAG/g" integration/gadget-integration-tests-job.yaml

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1.0.0
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Create Release Assets
      run: |
        # kubectl-gadget
        for target in $(make list-kubectl-gadget-targets); do
          platform=$(echo $target|cut -d- -f3-4)
          mkdir $platform
          cp kubectl-gadget-$platform $platform/kubectl-gadget
          cp LICENSE $platform/
          tar --sort=name --owner=root:0 --group=root:0 \
            -czf inspektor-gadget-$platform.tar.gz -C $platform \
            kubectl-gadget LICENSE
          rm -rf $platform
        done

      # localgadget
        for target in $(make list-local-gadget-targets); do
          platform=$(echo $target|cut -d- -f3-4)
          mkdir $platform
          cp local-gadget-$platform $platform/local-gadget
          cp LICENSE $platform/
          tar --sort=name --owner=root:0 --group=root:0 \
            -czf local-gadget-$platform.tar.gz -C $platform \
            local-gadget LICENSE
          rm -rf $platform
        done

    - name: Upload Gadget Release Assets
      uses: csexton/release-asset-action@v2
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        pattern: "*-gadget-*-*.tar.gz"
        github-token: ${{ secrets.GITHUB_TOKEN }}
        release-url: ${{ steps.create_release.outputs.upload_url }}

    - name: Upload Testing Asset
      id: upload-release-asset-testing
      uses: actions/upload-release-asset@v1.0.1
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: integration/gadget-integration-tests-job.yaml
        asset_name: gadget-integration-tests-job.yaml
        asset_content_type: application/x-yaml

    - name: Push Integration Test Image
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        make -C integration push

    - name: Update new version in krew-index
      if: |
        startsWith(github.ref, 'refs/tags/v')
        && github.repository == 'kinvolk/inspektor-gadget'
      uses: rajatjindal/krew-release-bot@v0.0.40
